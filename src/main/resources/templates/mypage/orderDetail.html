<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>흑백문고</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        /* 모달 백그라운드 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        /* 모달 컨텐츠 */
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* 닫기 버튼 */
        .close-button {
            float: right;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- 헤더 레이아웃 적용 -->
<header th:replace="~{layout :: header}"></header>

<!-- 마이페이지 헤더 영역 -->
<div id="mypage-header">
    <span class="header-title">마이페이지</span>
</div>

<!-- 마이페이지 메인 콘텐츠 영역 -->
<main class="mypage-container">

    <!-- 왼쪽 사이드바 -->
    <aside id="sidebar" th:replace="~{mypage/mypage-sidebar :: sidebar}"></aside>

    <!-- 오른쪽 콘텐츠 영역 -->
    <section id="content-area">
        <h2>주문내역/배송조회</h2>

        <h3 class="content-title">주문상품정보</h3>
        <table>
            <colgroup>
                <col style="width: 10%;">
                <col style="width: 50%;">
                <col style="width: 10%;">
                <col style="width: 10%;">
                <col style="width: 10%;">
                <col style="width: 10%;">
            </colgroup>
            <thead>
            <tr class="table-header">
                <th>상태</th>
                <th>상품명</th>
                <th>수량</th>
                <th>가격</th>
                <th>선택</th>
                <th>리뷰작성</th>
            </tr>
            </thead>
            <tbody style="font-size: 12px">
            <!-- 여러 책을 반복해서 표시 -->
            <tr th:each="book : ${myPageOrderDetailResponse.orderDetailResponse.books}">
                <td th:text="${myPageOrderDetailResponse.orderDetailResponse.status}">상태</td>
                <td>
                    <p class="book-title">
                        <a th:href="@{/books/detail(bookId=${book.id})}" th:text="${book.title}">상품명</a>
                    </p>
                </td>
                <td th:text="${book.quantity}">수량</td>
                <td th:text="${book.totalPrice} + '원'">가격</td>
                <td>
                    <label>
                        <input type="checkbox" name="selectedBooks" th:value="${book.id}" />
                    </label>
                </td>
                <td>
                    <button type="button" class="review-button"
                            th:attr="data-book-id=${book.id}, data-order-id=${orderId}"
                            onclick="openReviewModal(this)">리뷰작성</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="button-container">
            <button type="button" id="order-cancel-button" class="order-cancel-button">주문취소</button>
        </div>
    </section>
</main>

<!-- 리뷰 작성 모달 -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeReviewModal()">&times;</span>
        <h2>리뷰 작성</h2>
        <form id="reviewForm" method="POST" action="/members/mypage/reviews" enctype="multipart/form-data">
            <input type="hidden" id="bookId" name="bookId">
            <input type="hidden" id="orderId" name="orderId">
            <div>
                <label for="title">제목:</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div>
                <label for="content">내용:</label>
                <textarea id="content" name="content" required></textarea>
            </div>
            <div>
                <label for="score">평점:</label>
                <input type="number" id="score" name="score" min="1" max="5" required>
            </div>
            <div>
                <label for="images">이미지:</label>
                <input type="file" id="images" name="images" multiple>
            </div>
            <button type="submit">리뷰 등록</button>
        </form>
    </div>
</div>

<!-- 푸터 레이아웃 적용 -->
<footer th:replace="~{layout :: footer}"></footer>

<script>
    function openReviewModal(button) {
        const bookId = button.getAttribute('data-book-id');
        const orderId = button.getAttribute('data-order-id');

        // 값을 콘솔에 출력 (디버깅용)
        console.log('bookId:', bookId, 'orderId:', orderId);

        // 서버에서 사용할 데이터가 올바른지 확인
        if (!bookId || !orderId) {
            alert('필수 데이터가 없습니다.');
            return;
        }
        // 폼 데이터 설정
        document.getElementById('bookId').value = bookId;
        document.getElementById('orderId').value = orderId;

        // 모달 열기
        document.getElementById('reviewModal').style.display = 'flex';
    }

    function closeReviewModal() {
        // 모달 닫기
        document.getElementById('reviewModal').style.display = 'none';
    }
</script>

</body>
</html>
